const hamburger = document.querySelector(".hamburger");
const menu = document.querySelector(".opened__menu");
const close = document.querySelector(".close-icon");
const body = document.querySelector("body");

hamburger.addEventListener("click", function(event) {
  event.preventDefault();
  menu.classList.add("opened__menu--active");
  body.classList.add("noscroll");
})

close.addEventListener("click", function(event) {
  menu.classList.remove("opened__menu--active");
  body.classList.remove("noscroll");
})
;const openItem = item => {
  const container = item.closest(".team__item");
  const contentBlock = container.find(".team__content");
  const textBlock = contentBlock.find(".team__content-block");
  const reqHeight = textBlock.height();

  container.addClass("active");
  contentBlock.height(reqHeight);
};

const closeEveryItem = container => {
  const items = container.find(".team__content");
  const itemContainer = container.find(".team__item");

  itemContainer.removeClass("active");
  items.height(0);
};


$('.team__title').click (e => {
  const $this = $(e.currentTarget);
  const container = $this.closest('.team');
  const elemContainer = $this.closest(".team__item");

  if (elemContainer.hasClass("active")) {
    closeEveryItem(container);
  } else { 
    closeEveryItem(container);
    openItem($this);
  }
});;  
(function () {
  let myMap;
  
  const init = () => {
    myMap = new ymaps.Map("map", {
      center: [55.661689, 37.747406],
      zoom: 16,
      controls: ['zoomControl']
    });
  
    const coords = [
      [55.661562, 37.744073],
      [55.664009, 37.743813],
      [55.659647, 37.749661],
      [55.662750, 37.747100]
    ];
  
    var myCollection = new ymaps.GeoObjectCollection({}, {
      draggable: false,
      iconLayout: 'default#image',
      iconImageHref: '../images/icons/marker.svg',
      iconImageSize: [46, 57],
      iconImageOffset: [-21, -60]
    });
  
    coords.forEach(coord => {
      myCollection.add(new ymaps.Placemark(coord))
    });
  
    myMap.geoObjects.add(myCollection);
  
    myMap.behaviors.disable('scrollZoom');
  }
  
  ymaps.ready(init);
  
  }());;const mesureWidth = item => {
  let reqItemWidth = 0;
  const screenWidth = $(window).width();
  const container = item.closest(".products-menu");
  const titlesBlocks = container.find(".products-menu__title");
  const titlesWidth = titlesBlocks.width() * titlesBlocks.length;

  const textContainer = item.find(".products-menu__container");
  const paddingLeft = parseInt(textContainer.css("padding-left"));
  const paddingRight = parseInt(textContainer.css("padding-right"));

  const isMobile = window.matchMedia("(max-width: 768px)").matches;

  if (isMobile) {
    reqItemWidth = screenWidth - titlesWidth;
  } else {
    reqItemWidth = 500;  
  }

  return {
    container: reqItemWidth,
    textContainer: reqItemWidth - paddingRight - paddingLeft
  }
};

const closeEveryItemInContainer = (container) => {
  const items = container.find(".products-menu__item");
  const content = container.find (".products-menu__content");

  items.removeClass("active");
  content.width(0);
};

const openingItem = item => {
  const hiddenContent = item.find(".products-menu__content");
  const reqWidth = mesureWidth(item);
  const textBlock = item.find(".products-menu__container");

  item.addClass("active");
  hiddenContent.width(reqWidth.container);
  textBlock.width(reqWidth.textContainer);
};

$(".products-menu__title").on("click", (e) => {
  e.preventDefault();

  const $this = $(e.currentTarget);
  const item = $this.closest(".products-menu__item");
  const itemOpened = item.hasClass("active");
  const container = $this.closest(".products-menu");

  if (itemOpened) {
    closeEveryItemInContainer(container)
  } else {
    closeEveryItemInContainer(container)
    openingItem(item);
  }
});

$(".products-menu__close").on("click", (e) => {
  e.preventDefault();

  closeEveryItemInContainer($(".products-menu"));
});;const validateFields = (form, fieldsArray) => {
  
  fieldsArray.forEach((field) => {
    field.removeClass("input-error");
    if(field.val().trim()== "") {
      field.addClass("input-error");
    }
  });

  const errorFields = form.find('.input-error');

  return errorFields.length == 0;
}
$('.form').submit((e)=> {
  e.preventDefault();

  const form = $(e.currentTarget);
  const name = form.find("[name='name']");
  const phone = form.find("[name='phone']");
  const comment = form.find("[name='comment']");
  const to = form.find("[name='to']");

  const modal = $("#modal");
  const content = modal.find("modal__content")

  const isValid = validateFields(form, [name, phone, comment, to]);

  modal.removeClass("error-modal");
  
  if(isValid) {
   const request = $.ajax({
      url: "https://webdev-api.loftschool.com/sendmail",
      method: "post",
      data: {
        name: name.val(),
        phone: phone.val(),
        comment: comment.val(),
        to: to.val()
      },
    });

    request.done((data) => {
      content.text(data.message);
      });

    request.fail((data) => {   
      const message = data.responseJSON.message;
      content.text(message);
      modal.addClass("error-modal");
    });

    request.always(() => {
      $.fancybox.open({
        src: "#modal",
        type: "inline",
          
      });
    });
   }
});

$('.button-close').click(e => { 
  e.preventDefault();

  const form = $(e.currentTarget);

  $.fancybox.close();
  
  $('#form')[0].reset();
});

;const sections = $("section");
const display = $(".maincontent");
const sideMenu = $(".fixed-menu");
const menuItems = sideMenu.find("fixed-menu__item");

let inScroll = false;

const countSectionPosition = sectionEq => {
  return sectionEq * -100;
}

const changeMenuThemeForSection = (sectionEq) => {
  const currentSection = sections.eq(sectionEq);
  const menuTheme = currentSection.attr("data-sidemenu-theme");
  const activeClass = "fixed-menu--shadowed";


    if (menuTheme == "black") {
      sideMenu.addClass(activeClass);
    } else {
      sideMenu.removeClass(activeClass);
    }

}

const resetActiveClassForItem = (items, itemEq, activeClass) => {
  items.eq(itemEq).addClass(activeClass).siblings().removeClass(activeClass);
}

const performTransition = (sectionEq) => {
  if(inScroll) return;
    
  const transitionOver = 1000;
  const mouseInertiaOver = 300;

    inScroll = true;
    
    const position = countSectionPosition(sectionEq);

    changeMenuThemeForSection(sectionEq);

    display.css({
      transform: `translateY(${position}%)`,
    });

   resetActiveClassForItem(sections, sectionEq, "active");

   /*sections.eq(sectionEq).addClass("active").siblings().removeClass("active");*/

   sideMenu.find(".fixed-menu__item").eq(sectionEq).addClass("fixed-menu__item--active").siblings().removeClass("fixed-menu__item--active");

   setTimeout(() => {
    inScroll = false;
    resetActiveClassForItem(menuItems, sectionEq, "fixed-menu__item--active");
   }, transitionOver + mouseInertiaOver);
 
};

const scrollViewport = (direction) => {
  const activeSection = sections.filter(".active"); 
  const nextSection = activeSection.next();
  const prevSection = activeSection.prev();

  if (direction == "next" && nextSection.length) {
    performTransition(nextSection.index());
  }

  if (direction == "prev" && prevSection.length) {
    performTransition(prevSection.index());
  }
};

$(window).on("wheel", (e) => {
  const deltaY = e.originalEvent.deltaY;

  if (deltaY > 0) {
    
    scrollViewport("next");
  }

  if (deltaY < 0) {

    scrollViewport("prev");
  }
});

$(window).on("keydown", (e) => {

  const tagName = e.target.tagName.toLowerCase();
  const userTypingInputs = tagName == "input" || tagName == "textarea";

  if (userTypingInputs) return; 
    switch (e.keyCode) {
      case 38:
        scrollViewport("prev");
        break;
    
        case 40:
        scrollViewport("next");
        break;
   }
});

$("[data-scroll-to]").click(e =>{
  e.preventDefault();

  const $this = $(e.currentTarget);
  const target = $this.attr("data-scroll-to");
  const reqSection = $(`[data-section-id=${target}]`);

  performTransition(reqSection.index());


});;let player;
function onYouTubeIframeAPIReady() {
  player = new YT.Player("yt-player", {
    height: "370",
    width: "660",
    videoId: "awtmTJW9ic8",
    playerVars: {
      controls: 0,
      disablekb: 0,
      showinfo: 0,
      rel: 0,
      autoplay: 0,
      modestbranding: 0
    },
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange
    }
  });
}

function onPlayerStateChange(event) {
  const playerButton = $(".player__start");
  switch (event.data) {
    case 1:
      $(".player__wrapper").addClass("player__wrapper--active");
      playerButton.addClass("paused");
      break;
    case 2:
      playerButton.removeClass("paused");
      break;
  }
}

function onPlayerReady() {
  const duration = player.getDuration();
  let interval;

  clearInterval(interval);

  interval = setInterval(() => {
    const completedSeconds = player.getCurrentTime();
    const percent = (completedSeconds / duration) * 100;

    $(".player__playback-button").css({
      left: `${percent}%`
    });
  }, 1000);
}

$(".player__start").on("click", e => {
  const btn = $(e.currentTarget);

  if (btn.hasClass("paused")) {
    player.pauseVideo();
  } else {
    player.playVideo();
  }
});

$(".player__duration-line").on("click", e => {
  e.preventDefault();
  const bar = $(e.currentTarget);
  const newButtonPosition = e.pageX - bar.offset().left;
  const clickedPercent = (newButtonPosition / bar.width()) * 100;
  const newPlayerTime = (player.getDuration() / 100) * clickedPercent;

  $(".player__playback-button").css({
    left: `${clickedPercent}%`
  });

  player.seekTo(newPlayerTime);
});

$(".player__splash").on("click", e => {
  player.playVideo();
});

// sound
setTimeout(function() {
  const volBtn = $(".player__volume-button");
  const posVolBtnPx = volBtn.css("left");
  const posVolBtn = parseInt(posVolBtnPx);
  const volBar = document.querySelector(".player__volume-line");
  const volBarStyle = getComputedStyle(volBar);
  const volBarWidth = parseInt(volBarStyle.width);

  const posVolumePercent = (posVolBtn / volBarWidth) * 100;
  console.log(posVolumePercent);
  player.setVolume(posVolumePercent);

  $(".player__volume-line").on("click", e => {
    e.preventDefault();
    const barVol = $(e.currentTarget);
    const newButtonVolPosition = e.pageX - barVol.offset().left;
    const clickedVolPercent = (newButtonVolPosition / barVol.width()) * 100;

    if (clickedVolPercent < 100) {
      $(".player__volume-button").css({
        left: `${clickedVolPercent}%`
      });
    } else {
      $(".player__volume-button").css({
        left: `100%`
      });
    }

    player.unMute();
    player.setVolume(clickedVolPercent);
  });

  $(".player__volume-pic").on("click", e => {
    if (player.isMuted()) {
      player.unMute();
      $(".player__volume-button").css({
        left: `${posVolumePercent}%`
      });
      player.setVolume(posVolumePercent);
    } else {
      player.mute();
      $(".player__volume-button").css({
        left: 0
      });
    }
  });
}, 2000);;const slider = $(".slider").bxSlider({
  pager: false,
  controls: false
});

$(".arrow-left").click((e) => {

  slider.goToPrevSlide();

});

$(".arrow-right").click((e) => {

  slider.goToNextSlide();

});;const findBlockByAlias = (alias) => {
  return $(".reviews-item").filter((ndx, item) => {
    return $(item).attr("data-linked-with") == alias;
  });
};
$(".reviews-switcher__link").click((e) => { 
  e.preventDefault();


  const $this = $(e.currentTarget);
  const target = $this.attr("data-open");
  const itemToShow = findBlockByAlias(target);
  const curItem = $this.closest(".reviews-switcher__item");


  itemToShow.addClass("active").siblings().removeClass("active");
  curItem.addClass("active").siblings().removeClass("active");
}); 
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjEuanMiLCJhY2NvLmpzIiwibWFwLmpzIiwibWVudS1hY2NvLmpzIiwibW9kYWwuanMiLCJvcHMuanMiLCJwbGF5ZXIuanMiLCJzbGlkZXIuanMiLCJ0YWJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENDZkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUM5QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQ3JDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQy9EQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0N2RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElDakhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQzdIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQ2ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJtYWluLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGhhbWJ1cmdlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuaGFtYnVyZ2VyXCIpO1xuY29uc3QgbWVudSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIub3BlbmVkX19tZW51XCIpO1xuY29uc3QgY2xvc2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmNsb3NlLWljb25cIik7XG5jb25zdCBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcImJvZHlcIik7XG5cbmhhbWJ1cmdlci5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24oZXZlbnQpIHtcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgbWVudS5jbGFzc0xpc3QuYWRkKFwib3BlbmVkX19tZW51LS1hY3RpdmVcIik7XG4gIGJvZHkuY2xhc3NMaXN0LmFkZChcIm5vc2Nyb2xsXCIpO1xufSlcblxuY2xvc2UuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIG1lbnUuY2xhc3NMaXN0LnJlbW92ZShcIm9wZW5lZF9fbWVudS0tYWN0aXZlXCIpO1xuICBib2R5LmNsYXNzTGlzdC5yZW1vdmUoXCJub3Njcm9sbFwiKTtcbn0pXG4iLCJjb25zdCBvcGVuSXRlbSA9IGl0ZW0gPT4ge1xuICBjb25zdCBjb250YWluZXIgPSBpdGVtLmNsb3Nlc3QoXCIudGVhbV9faXRlbVwiKTtcbiAgY29uc3QgY29udGVudEJsb2NrID0gY29udGFpbmVyLmZpbmQoXCIudGVhbV9fY29udGVudFwiKTtcbiAgY29uc3QgdGV4dEJsb2NrID0gY29udGVudEJsb2NrLmZpbmQoXCIudGVhbV9fY29udGVudC1ibG9ja1wiKTtcbiAgY29uc3QgcmVxSGVpZ2h0ID0gdGV4dEJsb2NrLmhlaWdodCgpO1xuXG4gIGNvbnRhaW5lci5hZGRDbGFzcyhcImFjdGl2ZVwiKTtcbiAgY29udGVudEJsb2NrLmhlaWdodChyZXFIZWlnaHQpO1xufTtcblxuY29uc3QgY2xvc2VFdmVyeUl0ZW0gPSBjb250YWluZXIgPT4ge1xuICBjb25zdCBpdGVtcyA9IGNvbnRhaW5lci5maW5kKFwiLnRlYW1fX2NvbnRlbnRcIik7XG4gIGNvbnN0IGl0ZW1Db250YWluZXIgPSBjb250YWluZXIuZmluZChcIi50ZWFtX19pdGVtXCIpO1xuXG4gIGl0ZW1Db250YWluZXIucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XG4gIGl0ZW1zLmhlaWdodCgwKTtcbn07XG5cblxuJCgnLnRlYW1fX3RpdGxlJykuY2xpY2sgKGUgPT4ge1xuICBjb25zdCAkdGhpcyA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcbiAgY29uc3QgY29udGFpbmVyID0gJHRoaXMuY2xvc2VzdCgnLnRlYW0nKTtcbiAgY29uc3QgZWxlbUNvbnRhaW5lciA9ICR0aGlzLmNsb3Nlc3QoXCIudGVhbV9faXRlbVwiKTtcblxuICBpZiAoZWxlbUNvbnRhaW5lci5oYXNDbGFzcyhcImFjdGl2ZVwiKSkge1xuICAgIGNsb3NlRXZlcnlJdGVtKGNvbnRhaW5lcik7XG4gIH0gZWxzZSB7IFxuICAgIGNsb3NlRXZlcnlJdGVtKGNvbnRhaW5lcik7XG4gICAgb3Blbkl0ZW0oJHRoaXMpO1xuICB9XG59KTsiLCIgIFxuKGZ1bmN0aW9uICgpIHtcbiAgbGV0IG15TWFwO1xuICBcbiAgY29uc3QgaW5pdCA9ICgpID0+IHtcbiAgICBteU1hcCA9IG5ldyB5bWFwcy5NYXAoXCJtYXBcIiwge1xuICAgICAgY2VudGVyOiBbNTUuNjYxNjg5LCAzNy43NDc0MDZdLFxuICAgICAgem9vbTogMTYsXG4gICAgICBjb250cm9sczogWyd6b29tQ29udHJvbCddXG4gICAgfSk7XG4gIFxuICAgIGNvbnN0IGNvb3JkcyA9IFtcbiAgICAgIFs1NS42NjE1NjIsIDM3Ljc0NDA3M10sXG4gICAgICBbNTUuNjY0MDA5LCAzNy43NDM4MTNdLFxuICAgICAgWzU1LjY1OTY0NywgMzcuNzQ5NjYxXSxcbiAgICAgIFs1NS42NjI3NTAsIDM3Ljc0NzEwMF1cbiAgICBdO1xuICBcbiAgICB2YXIgbXlDb2xsZWN0aW9uID0gbmV3IHltYXBzLkdlb09iamVjdENvbGxlY3Rpb24oe30sIHtcbiAgICAgIGRyYWdnYWJsZTogZmFsc2UsXG4gICAgICBpY29uTGF5b3V0OiAnZGVmYXVsdCNpbWFnZScsXG4gICAgICBpY29uSW1hZ2VIcmVmOiAnLi4vaW1hZ2VzL2ljb25zL21hcmtlci5zdmcnLFxuICAgICAgaWNvbkltYWdlU2l6ZTogWzQ2LCA1N10sXG4gICAgICBpY29uSW1hZ2VPZmZzZXQ6IFstMjEsIC02MF1cbiAgICB9KTtcbiAgXG4gICAgY29vcmRzLmZvckVhY2goY29vcmQgPT4ge1xuICAgICAgbXlDb2xsZWN0aW9uLmFkZChuZXcgeW1hcHMuUGxhY2VtYXJrKGNvb3JkKSlcbiAgICB9KTtcbiAgXG4gICAgbXlNYXAuZ2VvT2JqZWN0cy5hZGQobXlDb2xsZWN0aW9uKTtcbiAgXG4gICAgbXlNYXAuYmVoYXZpb3JzLmRpc2FibGUoJ3Njcm9sbFpvb20nKTtcbiAgfVxuICBcbiAgeW1hcHMucmVhZHkoaW5pdCk7XG4gIFxuICB9KCkpOyIsImNvbnN0IG1lc3VyZVdpZHRoID0gaXRlbSA9PiB7XG4gIGxldCByZXFJdGVtV2lkdGggPSAwO1xuICBjb25zdCBzY3JlZW5XaWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICBjb25zdCBjb250YWluZXIgPSBpdGVtLmNsb3Nlc3QoXCIucHJvZHVjdHMtbWVudVwiKTtcbiAgY29uc3QgdGl0bGVzQmxvY2tzID0gY29udGFpbmVyLmZpbmQoXCIucHJvZHVjdHMtbWVudV9fdGl0bGVcIik7XG4gIGNvbnN0IHRpdGxlc1dpZHRoID0gdGl0bGVzQmxvY2tzLndpZHRoKCkgKiB0aXRsZXNCbG9ja3MubGVuZ3RoO1xuXG4gIGNvbnN0IHRleHRDb250YWluZXIgPSBpdGVtLmZpbmQoXCIucHJvZHVjdHMtbWVudV9fY29udGFpbmVyXCIpO1xuICBjb25zdCBwYWRkaW5nTGVmdCA9IHBhcnNlSW50KHRleHRDb250YWluZXIuY3NzKFwicGFkZGluZy1sZWZ0XCIpKTtcbiAgY29uc3QgcGFkZGluZ1JpZ2h0ID0gcGFyc2VJbnQodGV4dENvbnRhaW5lci5jc3MoXCJwYWRkaW5nLXJpZ2h0XCIpKTtcblxuICBjb25zdCBpc01vYmlsZSA9IHdpbmRvdy5tYXRjaE1lZGlhKFwiKG1heC13aWR0aDogNzY4cHgpXCIpLm1hdGNoZXM7XG5cbiAgaWYgKGlzTW9iaWxlKSB7XG4gICAgcmVxSXRlbVdpZHRoID0gc2NyZWVuV2lkdGggLSB0aXRsZXNXaWR0aDtcbiAgfSBlbHNlIHtcbiAgICByZXFJdGVtV2lkdGggPSA1MDA7ICBcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgY29udGFpbmVyOiByZXFJdGVtV2lkdGgsXG4gICAgdGV4dENvbnRhaW5lcjogcmVxSXRlbVdpZHRoIC0gcGFkZGluZ1JpZ2h0IC0gcGFkZGluZ0xlZnRcbiAgfVxufTtcblxuY29uc3QgY2xvc2VFdmVyeUl0ZW1JbkNvbnRhaW5lciA9IChjb250YWluZXIpID0+IHtcbiAgY29uc3QgaXRlbXMgPSBjb250YWluZXIuZmluZChcIi5wcm9kdWN0cy1tZW51X19pdGVtXCIpO1xuICBjb25zdCBjb250ZW50ID0gY29udGFpbmVyLmZpbmQgKFwiLnByb2R1Y3RzLW1lbnVfX2NvbnRlbnRcIik7XG5cbiAgaXRlbXMucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XG4gIGNvbnRlbnQud2lkdGgoMCk7XG59O1xuXG5jb25zdCBvcGVuaW5nSXRlbSA9IGl0ZW0gPT4ge1xuICBjb25zdCBoaWRkZW5Db250ZW50ID0gaXRlbS5maW5kKFwiLnByb2R1Y3RzLW1lbnVfX2NvbnRlbnRcIik7XG4gIGNvbnN0IHJlcVdpZHRoID0gbWVzdXJlV2lkdGgoaXRlbSk7XG4gIGNvbnN0IHRleHRCbG9jayA9IGl0ZW0uZmluZChcIi5wcm9kdWN0cy1tZW51X19jb250YWluZXJcIik7XG5cbiAgaXRlbS5hZGRDbGFzcyhcImFjdGl2ZVwiKTtcbiAgaGlkZGVuQ29udGVudC53aWR0aChyZXFXaWR0aC5jb250YWluZXIpO1xuICB0ZXh0QmxvY2sud2lkdGgocmVxV2lkdGgudGV4dENvbnRhaW5lcik7XG59O1xuXG4kKFwiLnByb2R1Y3RzLW1lbnVfX3RpdGxlXCIpLm9uKFwiY2xpY2tcIiwgKGUpID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIGNvbnN0ICR0aGlzID0gJChlLmN1cnJlbnRUYXJnZXQpO1xuICBjb25zdCBpdGVtID0gJHRoaXMuY2xvc2VzdChcIi5wcm9kdWN0cy1tZW51X19pdGVtXCIpO1xuICBjb25zdCBpdGVtT3BlbmVkID0gaXRlbS5oYXNDbGFzcyhcImFjdGl2ZVwiKTtcbiAgY29uc3QgY29udGFpbmVyID0gJHRoaXMuY2xvc2VzdChcIi5wcm9kdWN0cy1tZW51XCIpO1xuXG4gIGlmIChpdGVtT3BlbmVkKSB7XG4gICAgY2xvc2VFdmVyeUl0ZW1JbkNvbnRhaW5lcihjb250YWluZXIpXG4gIH0gZWxzZSB7XG4gICAgY2xvc2VFdmVyeUl0ZW1JbkNvbnRhaW5lcihjb250YWluZXIpXG4gICAgb3BlbmluZ0l0ZW0oaXRlbSk7XG4gIH1cbn0pO1xuXG4kKFwiLnByb2R1Y3RzLW1lbnVfX2Nsb3NlXCIpLm9uKFwiY2xpY2tcIiwgKGUpID0+IHtcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIGNsb3NlRXZlcnlJdGVtSW5Db250YWluZXIoJChcIi5wcm9kdWN0cy1tZW51XCIpKTtcbn0pOyIsImNvbnN0IHZhbGlkYXRlRmllbGRzID0gKGZvcm0sIGZpZWxkc0FycmF5KSA9PiB7XG4gIFxuICBmaWVsZHNBcnJheS5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgIGZpZWxkLnJlbW92ZUNsYXNzKFwiaW5wdXQtZXJyb3JcIik7XG4gICAgaWYoZmllbGQudmFsKCkudHJpbSgpPT0gXCJcIikge1xuICAgICAgZmllbGQuYWRkQ2xhc3MoXCJpbnB1dC1lcnJvclwiKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IGVycm9yRmllbGRzID0gZm9ybS5maW5kKCcuaW5wdXQtZXJyb3InKTtcblxuICByZXR1cm4gZXJyb3JGaWVsZHMubGVuZ3RoID09IDA7XG59XG4kKCcuZm9ybScpLnN1Ym1pdCgoZSk9PiB7XG4gIGUucHJldmVudERlZmF1bHQoKTtcblxuICBjb25zdCBmb3JtID0gJChlLmN1cnJlbnRUYXJnZXQpO1xuICBjb25zdCBuYW1lID0gZm9ybS5maW5kKFwiW25hbWU9J25hbWUnXVwiKTtcbiAgY29uc3QgcGhvbmUgPSBmb3JtLmZpbmQoXCJbbmFtZT0ncGhvbmUnXVwiKTtcbiAgY29uc3QgY29tbWVudCA9IGZvcm0uZmluZChcIltuYW1lPSdjb21tZW50J11cIik7XG4gIGNvbnN0IHRvID0gZm9ybS5maW5kKFwiW25hbWU9J3RvJ11cIik7XG5cbiAgY29uc3QgbW9kYWwgPSAkKFwiI21vZGFsXCIpO1xuICBjb25zdCBjb250ZW50ID0gbW9kYWwuZmluZChcIm1vZGFsX19jb250ZW50XCIpXG5cbiAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRlRmllbGRzKGZvcm0sIFtuYW1lLCBwaG9uZSwgY29tbWVudCwgdG9dKTtcblxuICBtb2RhbC5yZW1vdmVDbGFzcyhcImVycm9yLW1vZGFsXCIpO1xuICBcbiAgaWYoaXNWYWxpZCkge1xuICAgY29uc3QgcmVxdWVzdCA9ICQuYWpheCh7XG4gICAgICB1cmw6IFwiaHR0cHM6Ly93ZWJkZXYtYXBpLmxvZnRzY2hvb2wuY29tL3NlbmRtYWlsXCIsXG4gICAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgICAgZGF0YToge1xuICAgICAgICBuYW1lOiBuYW1lLnZhbCgpLFxuICAgICAgICBwaG9uZTogcGhvbmUudmFsKCksXG4gICAgICAgIGNvbW1lbnQ6IGNvbW1lbnQudmFsKCksXG4gICAgICAgIHRvOiB0by52YWwoKVxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJlcXVlc3QuZG9uZSgoZGF0YSkgPT4ge1xuICAgICAgY29udGVudC50ZXh0KGRhdGEubWVzc2FnZSk7XG4gICAgICB9KTtcblxuICAgIHJlcXVlc3QuZmFpbCgoZGF0YSkgPT4geyAgIFxuICAgICAgY29uc3QgbWVzc2FnZSA9IGRhdGEucmVzcG9uc2VKU09OLm1lc3NhZ2U7XG4gICAgICBjb250ZW50LnRleHQobWVzc2FnZSk7XG4gICAgICBtb2RhbC5hZGRDbGFzcyhcImVycm9yLW1vZGFsXCIpO1xuICAgIH0pO1xuXG4gICAgcmVxdWVzdC5hbHdheXMoKCkgPT4ge1xuICAgICAgJC5mYW5jeWJveC5vcGVuKHtcbiAgICAgICAgc3JjOiBcIiNtb2RhbFwiLFxuICAgICAgICB0eXBlOiBcImlubGluZVwiLFxuICAgICAgICAgIFxuICAgICAgfSk7XG4gICAgfSk7XG4gICB9XG59KTtcblxuJCgnLmJ1dHRvbi1jbG9zZScpLmNsaWNrKGUgPT4geyBcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gIGNvbnN0IGZvcm0gPSAkKGUuY3VycmVudFRhcmdldCk7XG5cbiAgJC5mYW5jeWJveC5jbG9zZSgpO1xuICBcbiAgJCgnI2Zvcm0nKVswXS5yZXNldCgpO1xufSk7XG5cbiIsImNvbnN0IHNlY3Rpb25zID0gJChcInNlY3Rpb25cIik7XG5jb25zdCBkaXNwbGF5ID0gJChcIi5tYWluY29udGVudFwiKTtcbmNvbnN0IHNpZGVNZW51ID0gJChcIi5maXhlZC1tZW51XCIpO1xuY29uc3QgbWVudUl0ZW1zID0gc2lkZU1lbnUuZmluZChcImZpeGVkLW1lbnVfX2l0ZW1cIik7XG5cbmxldCBpblNjcm9sbCA9IGZhbHNlO1xuXG5jb25zdCBjb3VudFNlY3Rpb25Qb3NpdGlvbiA9IHNlY3Rpb25FcSA9PiB7XG4gIHJldHVybiBzZWN0aW9uRXEgKiAtMTAwO1xufVxuXG5jb25zdCBjaGFuZ2VNZW51VGhlbWVGb3JTZWN0aW9uID0gKHNlY3Rpb25FcSkgPT4ge1xuICBjb25zdCBjdXJyZW50U2VjdGlvbiA9IHNlY3Rpb25zLmVxKHNlY3Rpb25FcSk7XG4gIGNvbnN0IG1lbnVUaGVtZSA9IGN1cnJlbnRTZWN0aW9uLmF0dHIoXCJkYXRhLXNpZGVtZW51LXRoZW1lXCIpO1xuICBjb25zdCBhY3RpdmVDbGFzcyA9IFwiZml4ZWQtbWVudS0tc2hhZG93ZWRcIjtcblxuXG4gICAgaWYgKG1lbnVUaGVtZSA9PSBcImJsYWNrXCIpIHtcbiAgICAgIHNpZGVNZW51LmFkZENsYXNzKGFjdGl2ZUNsYXNzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2lkZU1lbnUucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpO1xuICAgIH1cblxufVxuXG5jb25zdCByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbSA9IChpdGVtcywgaXRlbUVxLCBhY3RpdmVDbGFzcykgPT4ge1xuICBpdGVtcy5lcShpdGVtRXEpLmFkZENsYXNzKGFjdGl2ZUNsYXNzKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzKTtcbn1cblxuY29uc3QgcGVyZm9ybVRyYW5zaXRpb24gPSAoc2VjdGlvbkVxKSA9PiB7XG4gIGlmKGluU2Nyb2xsKSByZXR1cm47XG4gICAgXG4gIGNvbnN0IHRyYW5zaXRpb25PdmVyID0gMTAwMDtcbiAgY29uc3QgbW91c2VJbmVydGlhT3ZlciA9IDMwMDtcblxuICAgIGluU2Nyb2xsID0gdHJ1ZTtcbiAgICBcbiAgICBjb25zdCBwb3NpdGlvbiA9IGNvdW50U2VjdGlvblBvc2l0aW9uKHNlY3Rpb25FcSk7XG5cbiAgICBjaGFuZ2VNZW51VGhlbWVGb3JTZWN0aW9uKHNlY3Rpb25FcSk7XG5cbiAgICBkaXNwbGF5LmNzcyh7XG4gICAgICB0cmFuc2Zvcm06IGB0cmFuc2xhdGVZKCR7cG9zaXRpb259JSlgLFxuICAgIH0pO1xuXG4gICByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShzZWN0aW9ucywgc2VjdGlvbkVxLCBcImFjdGl2ZVwiKTtcblxuICAgLypzZWN0aW9ucy5lcShzZWN0aW9uRXEpLmFkZENsYXNzKFwiYWN0aXZlXCIpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7Ki9cblxuICAgc2lkZU1lbnUuZmluZChcIi5maXhlZC1tZW51X19pdGVtXCIpLmVxKHNlY3Rpb25FcSkuYWRkQ2xhc3MoXCJmaXhlZC1tZW51X19pdGVtLS1hY3RpdmVcIikuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhcImZpeGVkLW1lbnVfX2l0ZW0tLWFjdGl2ZVwiKTtcblxuICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaW5TY3JvbGwgPSBmYWxzZTtcbiAgICByZXNldEFjdGl2ZUNsYXNzRm9ySXRlbShtZW51SXRlbXMsIHNlY3Rpb25FcSwgXCJmaXhlZC1tZW51X19pdGVtLS1hY3RpdmVcIik7XG4gICB9LCB0cmFuc2l0aW9uT3ZlciArIG1vdXNlSW5lcnRpYU92ZXIpO1xuIFxufTtcblxuY29uc3Qgc2Nyb2xsVmlld3BvcnQgPSAoZGlyZWN0aW9uKSA9PiB7XG4gIGNvbnN0IGFjdGl2ZVNlY3Rpb24gPSBzZWN0aW9ucy5maWx0ZXIoXCIuYWN0aXZlXCIpOyBcbiAgY29uc3QgbmV4dFNlY3Rpb24gPSBhY3RpdmVTZWN0aW9uLm5leHQoKTtcbiAgY29uc3QgcHJldlNlY3Rpb24gPSBhY3RpdmVTZWN0aW9uLnByZXYoKTtcblxuICBpZiAoZGlyZWN0aW9uID09IFwibmV4dFwiICYmIG5leHRTZWN0aW9uLmxlbmd0aCkge1xuICAgIHBlcmZvcm1UcmFuc2l0aW9uKG5leHRTZWN0aW9uLmluZGV4KCkpO1xuICB9XG5cbiAgaWYgKGRpcmVjdGlvbiA9PSBcInByZXZcIiAmJiBwcmV2U2VjdGlvbi5sZW5ndGgpIHtcbiAgICBwZXJmb3JtVHJhbnNpdGlvbihwcmV2U2VjdGlvbi5pbmRleCgpKTtcbiAgfVxufTtcblxuJCh3aW5kb3cpLm9uKFwid2hlZWxcIiwgKGUpID0+IHtcbiAgY29uc3QgZGVsdGFZID0gZS5vcmlnaW5hbEV2ZW50LmRlbHRhWTtcblxuICBpZiAoZGVsdGFZID4gMCkge1xuICAgIFxuICAgIHNjcm9sbFZpZXdwb3J0KFwibmV4dFwiKTtcbiAgfVxuXG4gIGlmIChkZWx0YVkgPCAwKSB7XG5cbiAgICBzY3JvbGxWaWV3cG9ydChcInByZXZcIik7XG4gIH1cbn0pO1xuXG4kKHdpbmRvdykub24oXCJrZXlkb3duXCIsIChlKSA9PiB7XG5cbiAgY29uc3QgdGFnTmFtZSA9IGUudGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcbiAgY29uc3QgdXNlclR5cGluZ0lucHV0cyA9IHRhZ05hbWUgPT0gXCJpbnB1dFwiIHx8IHRhZ05hbWUgPT0gXCJ0ZXh0YXJlYVwiO1xuXG4gIGlmICh1c2VyVHlwaW5nSW5wdXRzKSByZXR1cm47IFxuICAgIHN3aXRjaCAoZS5rZXlDb2RlKSB7XG4gICAgICBjYXNlIDM4OlxuICAgICAgICBzY3JvbGxWaWV3cG9ydChcInByZXZcIik7XG4gICAgICAgIGJyZWFrO1xuICAgIFxuICAgICAgICBjYXNlIDQwOlxuICAgICAgICBzY3JvbGxWaWV3cG9ydChcIm5leHRcIik7XG4gICAgICAgIGJyZWFrO1xuICAgfVxufSk7XG5cbiQoXCJbZGF0YS1zY3JvbGwtdG9dXCIpLmNsaWNrKGUgPT57XG4gIGUucHJldmVudERlZmF1bHQoKTtcblxuICBjb25zdCAkdGhpcyA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcbiAgY29uc3QgdGFyZ2V0ID0gJHRoaXMuYXR0cihcImRhdGEtc2Nyb2xsLXRvXCIpO1xuICBjb25zdCByZXFTZWN0aW9uID0gJChgW2RhdGEtc2VjdGlvbi1pZD0ke3RhcmdldH1dYCk7XG5cbiAgcGVyZm9ybVRyYW5zaXRpb24ocmVxU2VjdGlvbi5pbmRleCgpKTtcblxuXG59KTsiLCJsZXQgcGxheWVyO1xuZnVuY3Rpb24gb25Zb3VUdWJlSWZyYW1lQVBJUmVhZHkoKSB7XG4gIHBsYXllciA9IG5ldyBZVC5QbGF5ZXIoXCJ5dC1wbGF5ZXJcIiwge1xuICAgIGhlaWdodDogXCIzNzBcIixcbiAgICB3aWR0aDogXCI2NjBcIixcbiAgICB2aWRlb0lkOiBcImF3dG1USlc5aWM4XCIsXG4gICAgcGxheWVyVmFyczoge1xuICAgICAgY29udHJvbHM6IDAsXG4gICAgICBkaXNhYmxla2I6IDAsXG4gICAgICBzaG93aW5mbzogMCxcbiAgICAgIHJlbDogMCxcbiAgICAgIGF1dG9wbGF5OiAwLFxuICAgICAgbW9kZXN0YnJhbmRpbmc6IDBcbiAgICB9LFxuICAgIGV2ZW50czoge1xuICAgICAgb25SZWFkeTogb25QbGF5ZXJSZWFkeSxcbiAgICAgIG9uU3RhdGVDaGFuZ2U6IG9uUGxheWVyU3RhdGVDaGFuZ2VcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBvblBsYXllclN0YXRlQ2hhbmdlKGV2ZW50KSB7XG4gIGNvbnN0IHBsYXllckJ1dHRvbiA9ICQoXCIucGxheWVyX19zdGFydFwiKTtcbiAgc3dpdGNoIChldmVudC5kYXRhKSB7XG4gICAgY2FzZSAxOlxuICAgICAgJChcIi5wbGF5ZXJfX3dyYXBwZXJcIikuYWRkQ2xhc3MoXCJwbGF5ZXJfX3dyYXBwZXItLWFjdGl2ZVwiKTtcbiAgICAgIHBsYXllckJ1dHRvbi5hZGRDbGFzcyhcInBhdXNlZFwiKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgMjpcbiAgICAgIHBsYXllckJ1dHRvbi5yZW1vdmVDbGFzcyhcInBhdXNlZFwiKTtcbiAgICAgIGJyZWFrO1xuICB9XG59XG5cbmZ1bmN0aW9uIG9uUGxheWVyUmVhZHkoKSB7XG4gIGNvbnN0IGR1cmF0aW9uID0gcGxheWVyLmdldER1cmF0aW9uKCk7XG4gIGxldCBpbnRlcnZhbDtcblxuICBjbGVhckludGVydmFsKGludGVydmFsKTtcblxuICBpbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICBjb25zdCBjb21wbGV0ZWRTZWNvbmRzID0gcGxheWVyLmdldEN1cnJlbnRUaW1lKCk7XG4gICAgY29uc3QgcGVyY2VudCA9IChjb21wbGV0ZWRTZWNvbmRzIC8gZHVyYXRpb24pICogMTAwO1xuXG4gICAgJChcIi5wbGF5ZXJfX3BsYXliYWNrLWJ1dHRvblwiKS5jc3Moe1xuICAgICAgbGVmdDogYCR7cGVyY2VudH0lYFxuICAgIH0pO1xuICB9LCAxMDAwKTtcbn1cblxuJChcIi5wbGF5ZXJfX3N0YXJ0XCIpLm9uKFwiY2xpY2tcIiwgZSA9PiB7XG4gIGNvbnN0IGJ0biA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcblxuICBpZiAoYnRuLmhhc0NsYXNzKFwicGF1c2VkXCIpKSB7XG4gICAgcGxheWVyLnBhdXNlVmlkZW8oKTtcbiAgfSBlbHNlIHtcbiAgICBwbGF5ZXIucGxheVZpZGVvKCk7XG4gIH1cbn0pO1xuXG4kKFwiLnBsYXllcl9fZHVyYXRpb24tbGluZVwiKS5vbihcImNsaWNrXCIsIGUgPT4ge1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIGNvbnN0IGJhciA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcbiAgY29uc3QgbmV3QnV0dG9uUG9zaXRpb24gPSBlLnBhZ2VYIC0gYmFyLm9mZnNldCgpLmxlZnQ7XG4gIGNvbnN0IGNsaWNrZWRQZXJjZW50ID0gKG5ld0J1dHRvblBvc2l0aW9uIC8gYmFyLndpZHRoKCkpICogMTAwO1xuICBjb25zdCBuZXdQbGF5ZXJUaW1lID0gKHBsYXllci5nZXREdXJhdGlvbigpIC8gMTAwKSAqIGNsaWNrZWRQZXJjZW50O1xuXG4gICQoXCIucGxheWVyX19wbGF5YmFjay1idXR0b25cIikuY3NzKHtcbiAgICBsZWZ0OiBgJHtjbGlja2VkUGVyY2VudH0lYFxuICB9KTtcblxuICBwbGF5ZXIuc2Vla1RvKG5ld1BsYXllclRpbWUpO1xufSk7XG5cbiQoXCIucGxheWVyX19zcGxhc2hcIikub24oXCJjbGlja1wiLCBlID0+IHtcbiAgcGxheWVyLnBsYXlWaWRlbygpO1xufSk7XG5cbi8vIHNvdW5kXG5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICBjb25zdCB2b2xCdG4gPSAkKFwiLnBsYXllcl9fdm9sdW1lLWJ1dHRvblwiKTtcbiAgY29uc3QgcG9zVm9sQnRuUHggPSB2b2xCdG4uY3NzKFwibGVmdFwiKTtcbiAgY29uc3QgcG9zVm9sQnRuID0gcGFyc2VJbnQocG9zVm9sQnRuUHgpO1xuICBjb25zdCB2b2xCYXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnBsYXllcl9fdm9sdW1lLWxpbmVcIik7XG4gIGNvbnN0IHZvbEJhclN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZSh2b2xCYXIpO1xuICBjb25zdCB2b2xCYXJXaWR0aCA9IHBhcnNlSW50KHZvbEJhclN0eWxlLndpZHRoKTtcblxuICBjb25zdCBwb3NWb2x1bWVQZXJjZW50ID0gKHBvc1ZvbEJ0biAvIHZvbEJhcldpZHRoKSAqIDEwMDtcbiAgY29uc29sZS5sb2cocG9zVm9sdW1lUGVyY2VudCk7XG4gIHBsYXllci5zZXRWb2x1bWUocG9zVm9sdW1lUGVyY2VudCk7XG5cbiAgJChcIi5wbGF5ZXJfX3ZvbHVtZS1saW5lXCIpLm9uKFwiY2xpY2tcIiwgZSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGNvbnN0IGJhclZvbCA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcbiAgICBjb25zdCBuZXdCdXR0b25Wb2xQb3NpdGlvbiA9IGUucGFnZVggLSBiYXJWb2wub2Zmc2V0KCkubGVmdDtcbiAgICBjb25zdCBjbGlja2VkVm9sUGVyY2VudCA9IChuZXdCdXR0b25Wb2xQb3NpdGlvbiAvIGJhclZvbC53aWR0aCgpKSAqIDEwMDtcblxuICAgIGlmIChjbGlja2VkVm9sUGVyY2VudCA8IDEwMCkge1xuICAgICAgJChcIi5wbGF5ZXJfX3ZvbHVtZS1idXR0b25cIikuY3NzKHtcbiAgICAgICAgbGVmdDogYCR7Y2xpY2tlZFZvbFBlcmNlbnR9JWBcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAkKFwiLnBsYXllcl9fdm9sdW1lLWJ1dHRvblwiKS5jc3Moe1xuICAgICAgICBsZWZ0OiBgMTAwJWBcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHBsYXllci51bk11dGUoKTtcbiAgICBwbGF5ZXIuc2V0Vm9sdW1lKGNsaWNrZWRWb2xQZXJjZW50KTtcbiAgfSk7XG5cbiAgJChcIi5wbGF5ZXJfX3ZvbHVtZS1waWNcIikub24oXCJjbGlja1wiLCBlID0+IHtcbiAgICBpZiAocGxheWVyLmlzTXV0ZWQoKSkge1xuICAgICAgcGxheWVyLnVuTXV0ZSgpO1xuICAgICAgJChcIi5wbGF5ZXJfX3ZvbHVtZS1idXR0b25cIikuY3NzKHtcbiAgICAgICAgbGVmdDogYCR7cG9zVm9sdW1lUGVyY2VudH0lYFxuICAgICAgfSk7XG4gICAgICBwbGF5ZXIuc2V0Vm9sdW1lKHBvc1ZvbHVtZVBlcmNlbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwbGF5ZXIubXV0ZSgpO1xuICAgICAgJChcIi5wbGF5ZXJfX3ZvbHVtZS1idXR0b25cIikuY3NzKHtcbiAgICAgICAgbGVmdDogMFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn0sIDIwMDApOyIsImNvbnN0IHNsaWRlciA9ICQoXCIuc2xpZGVyXCIpLmJ4U2xpZGVyKHtcbiAgcGFnZXI6IGZhbHNlLFxuICBjb250cm9sczogZmFsc2Vcbn0pO1xuXG4kKFwiLmFycm93LWxlZnRcIikuY2xpY2soKGUpID0+IHtcblxuICBzbGlkZXIuZ29Ub1ByZXZTbGlkZSgpO1xuXG59KTtcblxuJChcIi5hcnJvdy1yaWdodFwiKS5jbGljaygoZSkgPT4ge1xuXG4gIHNsaWRlci5nb1RvTmV4dFNsaWRlKCk7XG5cbn0pOyIsImNvbnN0IGZpbmRCbG9ja0J5QWxpYXMgPSAoYWxpYXMpID0+IHtcbiAgcmV0dXJuICQoXCIucmV2aWV3cy1pdGVtXCIpLmZpbHRlcigobmR4LCBpdGVtKSA9PiB7XG4gICAgcmV0dXJuICQoaXRlbSkuYXR0cihcImRhdGEtbGlua2VkLXdpdGhcIikgPT0gYWxpYXM7XG4gIH0pO1xufTtcbiQoXCIucmV2aWV3cy1zd2l0Y2hlcl9fbGlua1wiKS5jbGljaygoZSkgPT4geyBcbiAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cbiAgY29uc3QgJHRoaXMgPSAkKGUuY3VycmVudFRhcmdldCk7XG4gIGNvbnN0IHRhcmdldCA9ICR0aGlzLmF0dHIoXCJkYXRhLW9wZW5cIik7XG4gIGNvbnN0IGl0ZW1Ub1Nob3cgPSBmaW5kQmxvY2tCeUFsaWFzKHRhcmdldCk7XG4gIGNvbnN0IGN1ckl0ZW0gPSAkdGhpcy5jbG9zZXN0KFwiLnJldmlld3Mtc3dpdGNoZXJfX2l0ZW1cIik7XG5cblxuICBpdGVtVG9TaG93LmFkZENsYXNzKFwiYWN0aXZlXCIpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XG4gIGN1ckl0ZW0uYWRkQ2xhc3MoXCJhY3RpdmVcIikuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcbn0pOyAiXX0=
